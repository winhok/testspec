---
name: testspec-generate
description: TestSpec 生成测试用例 - 根据测试点（specs/*.md）生成完整测试用例并导出 Excel 或 XMind。当用户要生成用例、执行 testspec-generate Excel 或 testspec-generate XMind 时使用。对应流程中的「生成测试用例」步骤。不依赖外部技能，使用内置脚本完成生成。
---

# testspec-generate：用例生成

## 职责

读取当前变更的 `specs/*.md`（测试点），将测试点展开为完整的测试用例，根据用户指定的格式（Excel 或 XMind）生成测试用例文件，输出到当前变更的 `artifacts/` 目录。若存在 `strategy.md` 可参考其测试类型、层级与通过标准；否则使用默认策略（测试类型以功能为主，类型：正向/负向/边界/异常，优先级 P0/P1/P2/P3，通过标准为用例通过）。不依赖外部技能，使用本技能内置脚本完成生成。

## 当前变更目录

参见 `../testspec-shared/common.md` 中的「当前变更目录定位规则」。

---

## 测试点到用例的转换规则

### 转换原则

- **一对多映射**：一个测试点可能对应多个测试用例场景
- **场景细化**：根据测试点的验证要点，细化为具体的测试场景；涉及多种输入条件或状态时，须设计多个独立用例
- **数据驱动**：针对边界验证点，设计多组边界数据的测试用例
- **异常覆盖**：针对异常验证点，设计各种异常情况的测试用例
- **优先级独立判断**：测试点中的优先级仅供参考，每个用例根据具体场景独立判断；同一测试点可衍生 P1 到 P3 不同级别的用例

### 验证点类型对应

- 功能验证点 → 正向测试用例（验证功能正常工作）
- 边界验证点 → 边界测试用例（验证临界值处理）
- 异常验证点 → 异常测试用例（验证错误处理）
- 集成验证点 → 集成测试用例（验证模块间交互）
- 非功能性验证点 → 非功能测试用例（性能、安全、兼容性等）

---

## 用例设计方法

设计用例时须合理运用以下方法（按需选用，不必每个都机械套用）：

1. **等价类划分**：将输入数据划分为有效和无效等价类，每类至少 1 个用例
2. **边界值分析**：测试输入和输出的边界条件（最小值、最大值、临界值、空值）
3. **判定表驱动**：适用于多条件组合场景，列出所有条件组合并确保覆盖
4. **场景法**：基于用户实际使用场景设计，覆盖正常、异常、边界场景
5. **错误推测法**：基于经验推测可能出错的场景（网络中断、并发操作、安全风险）
6. **状态迁移法**：适用于有明确状态转换的模块，验证状态转换的正确性和完整性

---

## 用例类型与冒烟用例

### 类型定义

测试用例按类型分为：

- **冒烟用例**：最核心的基础验证用例，用于快速验证系统基本可用性（**必须占比 30%**）
- **正向用例**：验证功能正常工作的用例
- **负向用例**：验证错误处理的用例
- **边界用例**：验证临界值处理的用例
- **异常用例**：验证异常情况处理的用例
- **其他用例**：不属于以上分类的用例

### 冒烟用例识别标准（必须占比 30%）

冒烟用例是 P1 用例的核心子集，必须满足以下条件：

- **核心业务流程**：系统最基本、最重要的业务流程（如登录、支付、下单）
- **关键功能入口**：影响用户使用系统的关键功能入口
- **核心数据操作**：核心数据的增删改查基本操作
- **阻塞性功能**：失败会导致大部分其他功能无法使用
- **高频使用场景**：用户日常使用频率最高的核心功能

### 冒烟用例识别方法

- **用户旅程分析**：识别用户完成核心任务的最短路径，路径上的每个关键步骤都是冒烟用例候选
- **失败影响分析**：分析功能失败的影响范围，阻塞性强的功能为冒烟用例
- **使用频率分析**：高频操作场景对应的用例为冒烟用例候选
- **业务价值评估**：直接产生收入或核心竞争力的功能为冒烟用例

### 冒烟用例数量控制

- **强制占比**：冒烟用例必须占总用例数的 30%
- 冒烟用例占比不足时：从 P1 用例中提升核心路径关键步骤、高频功能、影响范围大的用例
- 冒烟用例占比过高时：降级非核心路径、低频操作、辅助功能的用例
- 质量优先于数量，不为凑数而降低冒烟用例质量

---

## 优先级规则

### 级别定义与占比

- **P1（核心功能）**：核心业务流程、关键功能入口、阻塞性功能（**占比约 50%**，包含所有冒烟用例）
- **P2（一般功能）**：影响次要业务流程的常规用例（占比约 30%）
- **P3（边缘功能）**：轻微影响或优化类的低优先级用例（占比约 20%）

### 类型与优先级的关系

- **冒烟用例**：必须是 P1，占总用例 30%
- **P1 用例**：包含所有冒烟用例 + 其他核心功能用例，占总用例 50%
- **正向/负向/边界/异常用例**：可以是 P1/P2/P3 任意级别

---

## 用例字段规范

### 编号

- 格式：`{需求名称}_YYYYMMDD{SEQ}`
- SEQ：四位数字递增（0001、0002、...）
- 日期使用当前日期，确保同一需求下编号唯一

### 用例标题

- 格式：`{模块}_{功能点}_{测试场景}`
- 使用下划线分隔各层级，清晰表达测试意图

### 用例标题（与 points 命名契约）

- 用例标题格式：`{模块}_{功能点}_{测试场景}`
- `{模块}`、`{功能点}`必须来自 points 文档的标题层级：
  - `### {模块}模块`
  - `#### {功能点}功能`
- 禁止使用同义词/缩写/替换词；前两段必须与 points 标题层级 **严格一致**
- 一个测试点可映射多个用例：同一测试点衍生的用例标题必须共享相同前缀 `{模块}_{功能点}_...`
- `{测试场景}`允许轻量场景词（正确/错误/边界/异常/权限不足/网络超时等），但避免具体数据

### 用例字段与分组约束（XMind/Excel）

- `feature` 字段必须等于 `{模块}`（用于 XMind 分组：`{feature} - 测试用例`）
- 用例标题的 `{模块}` 必须与 `feature` 一致

---

### 预置条件

- 每个条件带序号，使用换行分隔：`1、条件一\n2、条件二`
- 无特殊要求时可留空

### 操作步骤

- 每个步骤带序号，使用换行分隔：`1、步骤一\n2、步骤二`
- 步骤描述清晰、可执行，包含关键测试数据

### 测试预期内容

- 每个结果带序号（多个时），使用换行分隔：`1、预期一\n2、预期二`
- 结果必须具体、可验证，包含关键系统行为和状态变化
- 避免模糊描述（如"正常显示"应改为"显示用户头像，尺寸 200×200 像素"）

### 期望结果细分原则

复杂的期望结果应拆分为多个验证点，每个验证点设计独立用例：

- 按验证维度拆分（时效性、准确性、完整性、交互反馈等）
- 按验证对象拆分（数据、界面、状态、性能等）
- 按验证时机拆分（即时反馈、后续影响、持久化效果等）

### JSON 字符串转义规则

生成 testcases.json 时，所有字符串字段值必须符合 JSON 规范：

- 字段值中的双引号 `"` 必须转义为 `\"`
- 反斜杠 `\` 必须转义为 `\\`（`\n` 换行除外）
- 推荐使用中文引号「」替代双引号包裹 UI 文案，从源头避免转义问题
- 示例：`"expected_result": "1、按钮文案为\"去完成\""` 或 `"expected_result": "1、按钮文案为「去完成」"`

---

## 用例粒度控制

### 何时拆分

- 多个独立验证维度（数据准确性、界面显示、性能时效等）
- 不同验证点失败时影响不同
- 拆分后能更精确定位问题
- 需要完全不同的测试数据
- 同一功能的不同验证点有不同优先级

### 何时合并

- 验证点高度相关，属于同一原子操作的不同表现
- 操作步骤完全相同，只是观察角度不同
- 某些验证点必须在同一操作流程中完成
- 拆分导致用例数量过于庞大

---

## 用例质量标准

- **独立性**：每个用例可独立执行，不依赖其他用例结果
- **可重复性**：可重复执行并得到一致结果
- **可验证性**：预期结果具体且可验证
- **清晰性**：步骤和预期结果无歧义
- **完整性**：包含执行所需的所有信息
- **单一职责**：每个用例只验证一个明确的测试点或场景

---

## 输出格式

- **Excel**：生成 .xlsx 文件，列头依次为：编号、用例标题、级别、预置条件、操作步骤、测试预期内容、执行结果、执行人、执行日期、备注。
- **XMind**：生成 .xmind 思维导图（XMind 8 格式，兼容 XMind 桌面版打开），按功能模块组织，叶子节点使用用例标题（优先使用 title，其次 name），包含正向用例、负向用例、边界值用例、异常用例等分类。用例详情节点格式：`预置条件：xxx` → `{级别}操作步骤：xxx`（如 `P1操作步骤：xxx`）→ `期望结果：xxx`。

### Excel 列头与字段映射（以脚本为准）

> 本节是 **契约**：Excel 的 schema 以 `testspec-generate/scripts/generate_excel.py` 与对应单测为准；文档不得与实现/单测不一致。

#### 工作表

- 工作表名称固定：`测试用例`

#### 列头（固定 10 列）

1. 编号
2. 用例标题
3. 级别
4. 预置条件
5. 操作步骤
6. 测试预期内容
7. 执行结果
8. 执行人
9. 执行日期
10. 备注

#### testcases.json → Excel 字段映射

- **1 编号**：`id` 优先，其次 `case_id`，否则自动生成 `TC-xxx`（生成器兜底）
- **2 用例标题**：`title` 优先，其次 `name`
- **3 级别**：`priority`（默认 `P1`）
- **4 预置条件**：`preconditions`
- **5 操作步骤**：`steps`
- **6 测试预期内容**：`expected_result` 优先，其次 `expected`
- **7～10（执行结果/执行人/执行日期/备注）**：生成器写空字符串，**预留人工填写**

> 说明：当前 Excel schema **不包含**「功能模块」「类型」两列；如需写入这两列，属于**行为变更**（需要同步修改脚本与单测），而非仅调整文档。

### XMind 层级与字段映射（以脚本为准）

> 本节是契约：XMind 的树结构与节点文本以 `testspec-generate/scripts/generate_xmind.py` 与对应单测为准；文档不得与实现不一致。

#### 根节点结构

- Sheet 标题：由 `--title` 指定（默认 `测试用例`）
- Topic1（根节点）：`--title`
- Topic2（汇总节点）：`--title`（Topic1 的唯一子节点）

#### 分组层级（固定：feature → type → case）

- 功能模块（第 1 层）：来自 `feature`；缺失默认为 `未分类`；节点标题：`{feature} - 测试用例`
- 用例类型（第 2 层）：来自 `type`；缺失默认为 `其他`
  - 已知类型顺序固定：冒烟 / 正向 / 负向 / 边界 / 异常 / 其他
  - 未知类型：追加在后（不保证顺序）
  - 节点标题：`{type}用例`
- 用例（叶子节点）：标题 `title` 优先，其次 `name`

#### 用例详情子节点（链式嵌套）

若存在任一字段 `preconditions` / `steps` / `expected_result|expected`，则生成链式子节点（缺失的环节省略）：

`预置条件：{preconditions}` → `{priority}操作步骤：{steps}` → `期望结果：{expected_result|expected}`

#### markers（标记）

- type flag：冒烟=`flag-green`，正向/其他=`flag-blue`，负向/异常=`flag-red`，边界=`flag-yellow`
- priority：P1=`priority-1`，P2=`priority-2`，P3=`priority-3`

> 说明：优先级不作为分组层级（优先级通过 marker 与”{priority}操作步骤”前缀表达）。

可同时生成两种格式，如 testspec-generate Excel,XMind。

## 执行步骤

1. **确定当前变更目录**（按上规则）。
2. **读取上下文**：读取 `specs/*.md`（必须）；若存在 `strategy.md`、`requirements-analysis.md` 或 `proposal.md` 可一并读取以保持策略与优先级一致，否则按默认策略展开。
3. **从 specs 提取测试用例**：解析每个 spec 文件中的测试点，运用上述设计方法和转换规则将其展开为结构化测试用例列表。每个用例包含：
   - 功能/模块（必须来自 points 文档的标题层级 `### {模块}模块`；用例字段 `feature` 必须等于 `{模块}`）
   - 用例标题（格式：`{模块}_{功能点}_{测试场景}`；其中 `{模块}`/`{功能点}` 必须与 points 标题层级严格一致）
   - 类型：冒烟 / 正向 / 负向 / 边界 / 异常
   - 前置条件、步骤、预期结果
   - 优先级：P1 / P2 / P3
4. **生成 testcases.json**：在变更目录或 artifacts/ 下写入临时 `testcases.json`，供脚本读取。格式示例：

   ```json
   [
     {
       "id": "<需求名称>_202602280001",
       "title": "登录_凭据验证_正确凭据登录成功",
       "feature": "登录",
       "name": "正常登录-有效账号密码",
       "type": "正向",
       "preconditions": "1、系统已启动\n2、用户已注册",
       "steps": "1、打开登录页\n2、输入正确账号密码\n3、点击「登录」按钮",
       "expected_result": "1、登录成功，页面跳转至首页\n2、顶部显示「欢迎回来」提示",
       "priority": "P1"
     }
   ]
   ```

   > 注意：字段值中若包含双引号必须转义（`\"`），推荐用「」替代以避免转义问题。详见「JSON 字符串转义规则」。

5. **调用生成脚本**：
   - **Excel**：执行
     ```bash
     python ./scripts/generate_excel.py --input <变更目录>/testcases.json --output <变更目录>/artifacts/<name>_cases.xlsx
     ```
   - **XMind**：执行
     ```bash
     python ./scripts/generate_xmind.py --input <变更目录>/testcases.json --output <变更目录>/artifacts/<name>_cases.xmind --title "测试用例"
     ```
6. **清理**：可删除临时 testcases.json，或保留供用户审查。
7. **告知用户**：列出生成的文件路径及简要说明。

---

## 生成后自检与评审

生成完成后必须按以下维度进行自检：

### 覆盖度检查

- 测试点文档中的所有测试点都已覆盖
- 功能验证点、边界验证点、异常验证点均有对应用例
- 同一测试点衍生的多个场景用例优先级已独立判断
- 6 种设计方法已合理应用（等价类划分和边界值分析必须应用）
- 场景法已覆盖主要业务流程

### 覆盖度标准

- 功能覆盖度 ≥ 95%
- 业务规则覆盖度 100%
- 异常场景覆盖度 ≥ 90%
- 安全要求覆盖度 100%

### 设计质量检查

- 等价类划分合理（有效/无效等价类完整）
- 边界值分析充分（最小值、最大值、临界值）
- 正常、异常、边界场景齐全
- 用例独立性和可重复性达标

### 内容质量检查

- 用例标题简洁明确，格式 `{功能模块}_{功能点}_{测试场景}`
- 操作步骤详细、可操作、逻辑清晰
- 预期结果具体、可验证、无歧义
- 前置条件明确、完整、可执行
- 复杂期望结果已按细分原则拆分为独立用例
- 用例粒度适中，既不过粗也不过细

### 优先级分布检查

- 冒烟用例占比必须为 30%
- 冒烟用例必须全部为 P1
- P1 核心用例占比约 50%（包含所有冒烟用例）
- P1 覆盖核心业务流程和关键功能入口
- 各级别分布合理（P1≈50%, P2≈30%, P3≈20%）
- 未为凑数而降低冒烟用例质量

### 结构规范检查

- 编号格式规范（`{需求名称}_YYYYMMDD{SEQ}`）、唯一、连续
- 用例标题格式规范（`{功能模块}_{功能点}_{测试场景}`）
- 所有必要字段填写完整
- 序号统一使用中文顿号格式（1、2、3、）

### 发现问题时的处理

- 覆盖不足：补充缺失用例，编号从现有编号后连续递增
- 优先级不当：根据 P0 识别标准调整
- 粒度不当：按拆分/合并原则调整
- 调整后重新生成 testcases.json 和输出文件

---

## 依赖

- **Excel**：需要 `openpyxl`（`pip install openpyxl`）
- **XMind**：无额外依赖，使用 XMind 8 格式生成，兼容 XMind 桌面版打开

若 Excel 生成失败且提示缺少 openpyxl，请运行 `pip install openpyxl`。

## 产物

- `testspec/changes/<name>/artifacts/<name>_cases.xlsx`（Excel 格式）
- `testspec/changes/<name>/artifacts/<name>_cases.xmind`（XMind 格式）

文件名可根据变更名或用户指定调整。
